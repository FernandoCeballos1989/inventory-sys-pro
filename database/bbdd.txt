-- 1. CREACIÓN DE LA BASE DE DATOS
CREATE DATABASE IF NOT EXISTS sistema_inventario_pro;
USE sistema_inventario_pro;

-- 2. TABLA: CATEGORÍAS (Para clasificar productos)
CREATE TABLE categorias (
    id_categoria INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(50) NOT NULL,
    descripcion TEXT
) ENGINE=InnoDB;

-- 3. TABLA: PROVEEDORES (A quién le compramos)
CREATE TABLE proveedores (
    id_proveedor INT AUTO_INCREMENT PRIMARY KEY,
    nombre_empresa VARCHAR(100) NOT NULL,
    contacto_nombre VARCHAR(100),
    telefono VARCHAR(20),
    email VARCHAR(100),
    direccion TEXT
) ENGINE=InnoDB;

-- 4. TABLA: CLIENTES (A quién le vendemos)
CREATE TABLE clientes (
    id_cliente INT AUTO_INCREMENT PRIMARY KEY,
    nombre_completo VARCHAR(150) NOT NULL,
    identificacion_fiscal VARCHAR(20) UNIQUE, -- RFC, NIT, DNI, etc.
    email VARCHAR(100),
    telefono VARCHAR(20),
    direccion_envio TEXT,
    fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- 5. TABLA: PRODUCTOS (El núcleo del inventario)
CREATE TABLE productos (
    id_producto INT AUTO_INCREMENT PRIMARY KEY,
    sku VARCHAR(50) UNIQUE NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    id_categoria INT,
    precio_venta DECIMAL(10, 2) NOT NULL DEFAULT 0.00,
    stock_actual INT DEFAULT 0,
    stock_minimo INT DEFAULT 5,
    ubicacion_bodega VARCHAR(50),
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_categoria) REFERENCES categorias(id_categoria) ON DELETE SET NULL
) ENGINE=InnoDB;

-- 6. TABLA: MOVIMIENTOS_STOCK (El historial de transacciones)
CREATE TABLE movimientos_stock (
    id_movimiento INT AUTO_INCREMENT PRIMARY KEY,
    id_producto INT NOT NULL,
    id_proveedor INT DEFAULT NULL, -- Obligatorio solo si es ENTRADA
    id_cliente INT DEFAULT NULL,   -- Obligatorio solo si es SALIDA
    tipo_movimiento ENUM('ENTRADA', 'SALIDA', 'AJUSTE') NOT NULL,
    cantidad INT NOT NULL,
    precio_unitario_operacion DECIMAL(10, 2), -- Costo de compra o Precio de venta
    fecha_movimiento TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    notas VARCHAR(255),
    FOREIGN KEY (id_producto) REFERENCES productos(id_producto) ON DELETE CASCADE,
    FOREIGN KEY (id_proveedor) REFERENCES proveedores(id_proveedor) ON DELETE SET NULL,
    FOREIGN KEY (id_cliente) REFERENCES clientes(id_cliente) ON DELETE SET NULL
) ENGINE=InnoDB;

-- ---------------------------------------------------------
-- 7. TRIGGER: ACTUALIZACIÓN AUTOMÁTICA DE STOCK
-- ---------------------------------------------------------
DELIMITER //

CREATE TRIGGER tr_actualizar_stock_insert
AFTER INSERT ON movimientos_stock
FOR EACH ROW
BEGIN
    IF NEW.tipo_movimiento = 'ENTRADA' THEN
        UPDATE productos SET stock_actual = stock_actual + NEW.cantidad 
        WHERE id_producto = NEW.id_producto;
    ELSEIF NEW.tipo_movimiento = 'SALIDA' THEN
        UPDATE productos SET stock_actual = stock_actual - NEW.cantidad 
        WHERE id_producto = NEW.id_producto;
    ELSEIF NEW.tipo_movimiento = 'AJUSTE' THEN
        -- El ajuste suma o resta según el signo del número ingresado
        UPDATE productos SET stock_actual = stock_actual + NEW.cantidad 
        WHERE id_producto = NEW.id_producto;
    END IF;
END;
//

DELIMITER ;

-- ---------------------------------------------------------
-- 8. VISTA: REPORTE DE REPOSICIÓN (Stock Bajo)
-- ---------------------------------------------------------
CREATE VIEW vista_productos_criticos AS
SELECT 
    sku, 
    nombre, 
    stock_actual, 
    stock_minimo, 
    (stock_minimo - stock_actual) AS unidades_a_pedir
FROM productos
WHERE stock_actual <= stock_minimo;